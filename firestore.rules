/**
 * Firestore Security Rules
 * 
 * PROPÓSITO:
 * - Proteger colecciones compartidas entre APP - PRESENCIA y APP - TALENTO
 * - Implementar control de acceso basado en roles
 * - Prevenir escritura de PII en Firestore
 * 
 * ROLES:
 * - hr: Recursos Humanos (lectura de datos)
 * - admin: Administrador (lectura y escritura)
 * - system: Sistema automatizado (solo para logs)
 * 
 * @version 2.0
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ═══════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════════════
    
    /**
     * Verificar si el usuario está autenticado
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Verificar si el usuario tiene un rol específico
     */
    function userRole() {
      return request.auth.token.rol != null
        ? request.auth.token.rol
        : request.auth.token.role;
    }

    function hasRole(role) {
      return isAuthenticated() && userRole() == role;
    }
    
    /**
     * Verificar si el usuario tiene al menos uno de los roles especificados
     */
    function hasAnyRole(roles) {
      return isAuthenticated() && userRole() in roles;
    }
    
    /**
     * Validar que no se incluyan campos PII prohibidos
     * CRÍTICO PARA GDPR
     */
    function noPII() {
      let data = request.resource.data;
      return !('DescOperario' in data) &&
             !('nombre' in data) &&
             !('apellidos' in data) &&
             !('DNI' in data) &&
             !('NIF' in data) &&
             !('telefono' in data) &&
             !('email_personal' in data);
    }

    function isSuperAdmin() {
      return hasRole('SUPER_ADMIN');
    }

    function isHrRole() {
      return hasAnyRole(['SUPER_ADMIN', 'RRHH']);
    }

    function canUsePortal() {
      return hasAnyRole(['SUPER_ADMIN', 'RRHH', 'OPERADOR', 'GESTOR_TRABAJOS']);
    }

    function canReadTalento() {
      return hasAnyRole(['SUPER_ADMIN', 'RRHH', 'GESTOR_TRABAJOS']);
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: EMPLEADOS_REF (Datos compartidos con APP - TALENTO)
    // ═══════════════════════════════════════════════════════════════
    
    match /EMPLEADOS_REF/{employeeId} {
      // Lectura: roles de portal
      allow read: if canUsePortal();
      
      // Escritura: RRHH y SUPER_ADMIN, con validación anti-PII
      allow create, update: if isHrRole() && noPII();
      
      // Eliminación: Solo SUPER_ADMIN
      allow delete: if isSuperAdmin();
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: EMPLEADOS (Legacy - mantener por compatibilidad)
    // ═══════════════════════════════════════════════════════════════
    
    match /EMPLEADOS/{employeeId} {
      // Lectura: roles de portal
      allow read: if canUsePortal();
      
      // Escritura: RRHH y SUPER_ADMIN, con validación anti-PII
      allow create, update: if isHrRole() && noPII();
      
      // Eliminación: Solo SUPER_ADMIN
      allow delete: if isSuperAdmin();

      // Subcolecciones de interconexion entre apps
      match /talento_competencias/{docId} {
        allow read: if canReadTalento();
        allow write: if isHrRole();
      }

      match /talento_notas/{docId} {
        allow read: if canReadTalento();
        allow write: if isHrRole();
      }

      match /talento_certificaciones/{docId} {
        allow read: if canReadTalento();
        allow write: if isHrRole();
      }

      match /talento_formaciones/{docId} {
        allow read: if canReadTalento();
        allow write: if isHrRole();
      }

      match /talento_historial_evaluaciones/{docId} {
        allow read: if canReadTalento();
        allow write: if isHrRole();
      }

      match /presencia_bajas_activas/{docId} {
        allow read: if canUsePortal();
        allow write: if isHrRole();
      }

      match /presencia_bajas_historico/{docId} {
        allow read: if canUsePortal();
        allow write: if isHrRole();
      }

      match /presencia_incidencias/{docId} {
        allow read: if canUsePortal();
        allow write: if isHrRole();
      }

      match /presencia_fichajes_app/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }

      match /trabajos_partes/{docId} {
        allow read: if canUsePortal();
        allow write: if hasAnyRole(['SUPER_ADMIN', 'RRHH', 'GESTOR_TRABAJOS', 'OPERADOR']);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: USUARIOS (autenticación + roles unificados)
    // ═══════════════════════════════════════════════════════════════
    
    match /USUARIOS/{uid} {
      allow read: if isAuthenticated() && (request.auth.uid == uid || isHrRole());
      allow create, update, delete: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: CONFIGURACION
    // ═══════════════════════════════════════════════════════════════
    
    match /CONFIGURACION/{docId} {
      allow read: if canUsePortal();
      allow write: if isSuperAdmin();
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: COMPETENCIAS
    // ═══════════════════════════════════════════════════════════════
    
    match /COMPETENCIAS/{competenciaId} {
      // Lectura: HR y Admin
      allow read: if isHrRole();
      
      // Escritura: Solo SUPER_ADMIN
      allow write: if isSuperAdmin();
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: NOTAS
    // ═══════════════════════════════════════════════════════════════
    
    match /NOTAS/{notaId} {
      // Lectura: HR y Admin
      allow read: if isHrRole();
      
      // Creación: RRHH y SUPER_ADMIN pueden crear notas
      allow create: if isHrRole() &&
                       request.resource.data.autor == request.auth.token.email;
      
      // Actualización/Eliminación: Solo el autor o SUPER_ADMIN
      allow update, delete: if isSuperAdmin() || 
                               (isAuthenticated() && resource.data.autor == request.auth.token.email);
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: EMPLOYEE_AUDIT_LOG (Historial de Cambios)
    // ═══════════════════════════════════════════════════════════════
    
    match /EMPLOYEE_AUDIT_LOG/{logId} {
      // Lectura: Solo Admin
      allow read: if isSuperAdmin();
      
      // Escritura: Solo SUPER_ADMIN y sistema
      allow create: if hasAnyRole(['SUPER_ADMIN', 'system']);
      
      // NO permitir actualización ni eliminación (logs inmutables)
      allow update, delete: if false;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: EMPLOYEE_ACCESS_LOG (Registro de Accesos)
    // ═══════════════════════════════════════════════════════════════
    
    match /EMPLOYEE_ACCESS_LOG/{accessId} {
      // Lectura: Solo Admin
      allow read: if isSuperAdmin();
      
      // Creación: Cualquier usuario autenticado puede registrar su acceso
      allow create: if isAuthenticated() &&
                       request.resource.data.accessedBy == request.auth.token.email;
      
      // NO permitir actualización ni eliminación (logs inmutables)
      allow update, delete: if false;
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: SICK_LEAVES (Bajas Médicas)
    // ═══════════════════════════════════════════════════════════════
    
    match /SICK_LEAVES/{leaveId} {
      // Lectura: HR y Admin
      allow read: if isHrRole();
      
      // Escritura: Solo RRHH y SUPER_ADMIN
      allow write: if isHrRole();
    }

    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: BAJAS (Histórico de Bajas Finalizadas)
    // ═══════════════════════════════════════════════════════════════
    
    match /BAJAS/{bajaId} {
      // Lectura: HR y Admin (DEBUG: Relaxed to isAuthenticated for troubleshooting)
      allow read: if isAuthenticated();
      
      // Escritura: Solo RRHH y SUPER_ADMIN (para mover de activa a historico)
      allow write: if isHrRole();
    }
    
    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: INCIDENT_LOG
    // ═══════════════════════════════════════════════════════════════
    
    match /INCIDENT_LOG/{incidentId} {
      // Lectura: HR y Admin
      allow read: if isHrRole();
      
      // Creación: RRHH y SUPER_ADMIN
      allow create: if isHrRole();
      
      // NO permitir actualización ni eliminación (logs inmutables)
      allow update, delete: if false;
    }

    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: BAJAS_METADATA (Metadatos de bajas)
    // ═══════════════════════════════════════════════════════════════
    
    match /BAJAS_METADATA/{metadataId} {
      // Lectura: Cualquier usuario autenticado (incluyendo anónimos)
      allow read: if isAuthenticated();
      
      // Escritura: Solo RRHH y SUPER_ADMIN
      allow write: if isHrRole();
    }

    // ═══════════════════════════════════════════════════════════════
    // COLECCIÓN: APP_GENERATED_PUNCHES
    // ═══════════════════════════════════════════════════════════════
    
    match /APP_GENERATED_PUNCHES/{punchId} {
      // Lectura y Escritura: Cualquier usuario autenticado (incluyendo anónimos)
      allow read, write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // COLECCIONES TALENTO (compatibilidad actual)
    // ═══════════════════════════════════════════════════════════════

    match /SKILLS/{skillId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }

    match /COMPETENCY_DEFINITIONS/{definitionId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }

    match /CERTIFICACIONES/{certId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }

    match /HISTORIAL_EVALUACIONES/{historyId} {
      allow read: if canReadTalento();
      allow create: if isHrRole();
      allow update, delete: if isSuperAdmin();
    }

    match /FORMACIONES/{trainingId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }

    match /PLANES_FORMATIVOS_ANUALES/{planId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }

    match /FORMACION_JUSTIFICACIONES/{justificationId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }

    match /HOMOLOGACIONES_TECNICAS/{itemId} {
      allow read: if canReadTalento();
      allow write: if isHrRole();
    }
    
    // ═══════════════════════════════════════════════════════════════
    // REGLA POR DEFECTO: DENEGAR TODO LO DEMÁS
    // ═══════════════════════════════════════════════════════════════
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
